!===============================================================
!
!  Boundary conditions and builder of charge distribution for 1-dimensional
!  (wire) systems.
!
!---------------------------------------------------------------
subroutine hartset_wire(grid,pbc,rsymm,parallel,norder,lpole, &
     coeke,rho,brho)

  use constants
  use grid_module
  use pbc_module
  use symmetry_module
  use parallel_data_module
  implicit none
  !
  !  Input/Output variables:
  !
  !  grid related data
  type (grid_data), intent(in) :: grid
  !  periodic boundary conditions data
  type (pbc_data), intent(in) :: pbc
  !  symmetry operations in reduced group:
  type (symmetry), intent(in) :: rsymm
  !  parallel computation related data
  type (parallel_data), intent(in) :: parallel

  !  number of neighbors used for derivation (on one side)
  integer, intent(in) :: norder
  !  order of multipole expansion 
  integer, intent(in) :: lpole
  !  coefficients for taking a second derivative
  real(dp), intent(in) :: coeke(-norder:norder,3+grid%lap_dir_num)
  !  charge density on the 3-d grid
  real(dp), intent(in) :: rho(parallel%ldn)
  !  effective charge density = original charge density augmented by
  !  appropriate boundary terms, to be used as the source term in hpotcg
  real(dp), intent(out) :: brho(parallel%ldn)
  !
  !  Work variables:
  !
  !  offset for each processor
  integer ioffset
#ifdef DEBUG
  real(dp), dimension (:,:), allocatable :: tmpmax,tmpmin
  real(dp) :: tmpp
#endif

  !  twopia = 2 * pi / latt_param, constant
  real(dp) :: twopia
  !  lap_neibs = 2*( 3 + grid%lap_dir_num )
  integer lap_neibs
  !  nnmax = latt_param/grid_spacing * 2
  integer nnmax

  real(dp) :: &     ! for each grid point labeled by j,
       rrho, &             ! = rho(j)
       rw(3),rrw(3), &     ! grid point equiv. to (xx(j),yy(j),zz(j))
       yz, &               ! = sqrt(yy(j)^2 + zz(j)^2)
       cc, &               ! = cos(theta_j) = y/yz
       ss, &               ! = sin(theta_j) = z/yz
       yzn                 ! = 2*pi*yz*n/latt_param
  !  phx = exp( +/- 2 * i * pi * xx(j) *n / latt_param )
  complex(dpc), dimension (:), allocatable :: phx
  complex(dpc) :: ypiz(0:lpole)       ! = exp( +/- i * theta_j * m)
  !  temporary storage of the modified Bessel functions and their
  !  degenerate limits
  real(dp) :: pmn(0:lpole)
  !  Multipoles
  complex(dpc), dimension (:,:), allocatable :: qmn

  !  Contribution to the boundary potential (the contribution is the
  !  real part of this quantity).
  complex(dpc) :: cpole

  !  other counters
  integer ii,mm,nn,jshell,jrow,itrans
  real(dp) :: tmp,tmp1
  !  constants
  real(dp), parameter :: pi8 = eight*pi
  ! ln2g = -Euler + ln(2) - Euler-Mascheroni constant
  real(dp), parameter :: ln2g = 0.1159315156584124488d0

  !---------------------------------------------------------------

  nnmax = lpole
  allocate(phx(0:nnmax))
  allocate(qmn(-lpole:lpole, 0:nnmax))
#ifdef DEBUG
  allocate(tmpmax(-lpole:lpole, 0:nnmax))
  allocate(tmpmin(-lpole:lpole, 0:nnmax))
#endif
  lap_neibs = 2*( 3 + grid%lap_dir_num )
  twopia = two * pi / pbc%latt_vec(1,1)
  brho(:) = zero
  ioffset = parallel%irows(parallel%group_iam) - 1
  !  Zero out all of the qmn entries.
  qmn(:,:) = zzero
  pmn(:) = zero
  !
  !  We need to populate the qlm entries by adding in the
  !  contribution from every grid point that we have data for.
  !
  do itrans = 1, rsymm%ntrans
     do ii = parallel%irows(parallel%group_iam) &
          ,parallel%irows(parallel%group_iam+1)-1
        rrho = rho(ii-ioffset)
        rw(1) = (grid%shift(1) + grid%kx(ii)) * grid%step(1)
        rw(2) = (grid%shift(2) + grid%ky(ii)) * grid%step(2)
        rw(3) = (grid%shift(3) + grid%kz(ii)) * grid%step(3)
        call matvec3('N',pbc%avec_norm,rw,rrw)
        call symop(rsymm,itrans,rrw,rw)

        yz = rw(2) * rw(2) + rw(3) * rw(3)
        if( yz == 0 ) then
            cycle
        end if
        if (yz > zero) yz = sqrt(yz)
        tmp1 = one / yz
        cc = rw(2) * tmp1
        ss = rw(3) * tmp1
        ypiz(0) = zone
        ypiz(1) = cmplx(cc,-ss,dpc)
        do mm = 2, lpole
           ypiz(mm) = ypiz(mm-1) * ypiz(1)
        enddo

        tmp = one
        do mm = 1, lpole
           tmp = tmp * yz
           qmn(mm,0) = qmn(mm,0) + rrho * ypiz(mm) * tmp
        enddo

        phx(0) = zone
        phx(1) = -zi * twopia * rw(1)
        phx(1) = exp(phx(1))
        do nn = 2, nnmax
           phx(nn) = phx(nn-1) * phx(1)
        enddo

        yzn = zero
        do nn = 1, nnmax
           yzn = yzn + twopia * yz
           call bessel_i(lpole,yzn,pmn(0:lpole))
           qmn(0,nn) = qmn(0,nn) + rrho * phx(nn) * pmn(0)
           do mm = 1, lpole
              qmn(mm,nn) = qmn(mm,nn) + rrho * ypiz(mm) * phx(nn) * pmn(mm)
              qmn(-mm,nn) = qmn(-mm,nn) + &
                   rrho * conjg(ypiz(mm)) * phx(nn) * pmn(mm)
           enddo
        enddo

     enddo                  !  %irows
  enddo                     !  itrans = 1, rsymm%ntrans

  qmn(0,0) = sum(rho(1:parallel%mydim))*real(rsymm%ntrans,dp)

  !
  !  Global sum for colecting the qlms from each processor.
  call zpsum(qmn,(2*lpole+1)*(nnmax+1),parallel%group_size,parallel%group_comm)

  tmp = four * grid%hcub / pbc%latt_vec(1,1)
  qmn = qmn * tmp
#ifdef DEBUG
  write(9,*) ' multipoles : '
  do nn = 0, nnmax
     do mm = -lpole, lpole
        write(9,*) mm,nn,real(qmn(mm,nn))
     enddo
  enddo
#endif
  !
  !  Start with the boundary rho (brho) equal to 8*pi*rho.
  !
  do ii = parallel%irows(parallel%group_iam), &
       parallel%irows(parallel%group_iam+1)-1
     brho(ii-ioffset) = rho(ii-ioffset)*pi8
  enddo
#ifdef DEBUG
  if (parallel%iammaster) then
     write(7,*)
     write(7,*) ' charge bounds in master PE = ',minval(brho),maxval(brho)
     write(7,*)
  endif
#endif
  !
  !  Go through each neighbour in all necessary directions
  !  (+/-x, +/-y, +/-z) for the order needed.
  !
#ifdef DEBUG_
  tmp1 = zero
  tmpmax = -one
  tmpmin = zero
#endif
  do ii = parallel%irows(parallel%group_iam), &
       parallel%irows(parallel%group_iam+1)-1
     do jshell = 1, norder
        do jrow = 1, lap_neibs
           !
           !  If this neighbor is outside the sphere then its neibs value
           !  will be greater than ndim. We can then find the position of
           !  this point and calculate its contribution to brho.
           !
           if (parallel%neibs(jrow+(jshell-1)*lap_neibs,ii-ioffset) &
                > parallel%nwedge) then
              rw(1) = (grid%shift(1) + grid%kx(ii)) * grid%step(1)
              rw(2) = (grid%shift(2) + grid%ky(ii)) * grid%step(2)
              rw(3) = (grid%shift(3) + grid%kz(ii)) * grid%step(3)

              select case(jrow)
              case (1)
                 rw(1) = rw(1) - grid%step(1)*jshell
              case (2)
                 rw(1) = rw(1) + grid%step(1)*jshell
              case (3)
                 rw(2) = rw(2) - grid%step(2)*jshell
              case (4)
                 rw(2) = rw(2) + grid%step(2)*jshell
              case (5)
                 rw(3) = rw(3) - grid%step(3)*jshell
              case (6)
                 rw(3) = rw(3) + grid%step(3)*jshell
              case (7)
                 rw(1) = rw(1) - grid%step(1)*jshell
                 rw(2) = rw(2) - grid%step(2)*jshell* &
                      grid%lap_dir(1)
              case (8)
                 rw(1) = rw(1) + grid%step(1)*jshell
                 rw(2) = rw(2) + grid%step(2)*jshell* &
                      grid%lap_dir(1)
              case (9)
                 rw(1) = rw(1) - grid%step(1)*jshell
                 rw(3) = rw(3) - grid%step(3)*jshell* &
                      grid%lap_dir(2)
              case (10)
                 rw(1) = rw(1) + grid%step(1)*jshell
                 rw(3) = rw(3) + grid%step(3)*jshell* &
                      grid%lap_dir(2)
              case (11)
                 rw(2) = rw(2) - grid%step(2)*jshell
                 rw(3) = rw(3) - grid%step(3)*jshell* &
                      grid%lap_dir(3)
              case (12)
                 rw(2) = rw(2) + grid%step(2)*jshell
                 rw(3) = rw(3) + grid%step(3)*jshell* &
                      grid%lap_dir(3)
              end select

              yz = rw(2) * rw(2) + rw(3) * rw(3)
              if (yz > zero) yz = sqrt(yz)
              tmp1 = one / yz
              cc = rw(2) * tmp1
              ss = rw(3) * tmp1
              ypiz(0) = zone
              ypiz(1) = cmplx(cc,ss,dpc)
              do mm = 2, lpole
                 ypiz(mm) = ypiz(mm-1) * ypiz(1)
              enddo

              cpole = zzero
              tmp = half
              tmp1 = one / yz
              do mm = 1, lpole
                 tmp = tmp * tmp1
                 cpole = cpole + qmn(mm,0) * ypiz(mm) * tmp / real(mm,dp)
#ifdef DEBUG_
                 tmpp = tmp / real(mm,dp)
                 if (tmpmax(mm,0) < zero) tmpmin(mm,0) = tmpp
                 if (tmpmin(mm,0) > tmpp) tmpmin(mm,0) = tmpp
                 if (tmpmax(mm,0) < tmpp) tmpmax(mm,0) = tmpp
#endif
              enddo

              phx(0) = zone
              phx(1) = zi * twopia * rw(1)
              phx(1) = exp(phx(1))
              do nn = 2, nnmax
                 phx(nn) = phx(nn-1) * phx(1)
              enddo

              yzn = zero
              do nn = 1, nnmax
                 yzn = yzn + twopia * yz
                 call bessel_k(lpole,yzn,pmn(0:lpole))
                 cpole = cpole + qmn(0,nn) * phx(nn) * pmn(0)
#ifdef DEBUG_
                    tmpp = pmn(0)
                    if (tmpmax(0,nn) < zero) tmpmin(0,nn) = tmpp
                    if (tmpmin(0,nn) > tmpp) tmpmin(0,nn) = tmpp
                    if (tmpmax(0,nn) < tmpp) tmpmax(0,nn) = tmpp
#endif
                 do mm = 1, lpole
                    cpole = cpole + phx(nn) * pmn(mm) * &
                         (qmn(mm,nn) * ypiz(mm) + &
                         qmn(-mm,nn) * conjg(ypiz(mm)))
#ifdef DEBUG_
                    tmpp = pmn(mm)
                    if (tmpmax(mm,nn) < zero) tmpmin(mm,nn) = tmpp
                    if (tmpmin(mm,nn) > tmpp) tmpmin(mm,nn) = tmpp
                    if (tmpmax(mm,nn) < tmpp) tmpmax(mm,nn) = tmpp
#endif
                 enddo
              enddo

              cpole = cpole + qmn(0,0) * (ln2g - &
                      log(yz/pbc%latt_vec(1,1)))*half


              !
              !  Add the contributions into brho, but scale by two
              !  (sum over positive and negative m,n) and by coeke.
              !
              brho(ii-ioffset) = brho(ii-ioffset) - &
                   two*coeke(jshell,(jrow+1)/2)*real(cpole,dp)
#ifdef DEBUG_
              tmp1 = tmp1 - two*coeke(jshell,(jrow+1)/2)*real(cpole,dp)
              do mm = -lpole, lpole
              enddo
#endif
           endif
        enddo               ! jrow = 1, lap_neibs
     enddo                  ! jshell = 1, norder
  enddo
#ifdef DEBUG_
  ! Check charge neutrality
  call psum(tmp1,1,parallel%group_size,parallel%group_comm)
  if (parallel%iammaster) then
     write(7,*) ' charge bounds in master PE = ',minval(brho),maxval(brho)
     write(7,*) ' net boundary correction = ',tmp1/pi8
     write(7,*)
  endif
#endif
#ifdef DEBUG_
  write(9,*) ' bounds : '
  do nn = 0, nnmax
     do mm = 0, lpole
        write(9,*) mm,nn,tmpmin(mm,nn)*real(qmn(mm,nn)), &
             tmpmax(mm,nn)*real(qmn(mm,nn))
     enddo
  enddo
#endif

  deallocate(phx)
  deallocate(qmn)
#ifdef DEBUG
  deallocate(tmpmax)
  deallocate(tmpmin)
#endif

end subroutine hartset_wire
!===============================================================
!
!  Functions for the calculation of modified Bessel functions with
!  non-zero argument.
!
!  WARNING: Coding for modified Bessel functions (bessel_i, bessel_k,
!  bessi0, bessi1, bessk0, bessk1) is copyrighted by Numerical Recipes.
!  They must be replaced with copyright-free equivalents before attaching
!  GPL license to this file.
!
subroutine bessel_i(n,x,bessi)
  use constants
  implicit none
  integer, intent(in) :: n
  real(dp), intent(in) :: x
  real(dp), intent(out) :: bessi(0:n)
  integer, parameter :: iacc = 40
  real(dp), parameter :: bigno=1.0d30, bigni=1.0d-30
  integer :: j, m
  real(dp) :: bi, bim, bip, tox
  real(dp), external :: bessi0, bessi1

  if (x == zero) then
     bessi = zero
     bessi(0) = one
     return
  endif
  if (n == 0) then
     bessi(0) = bessi0(x)
     return
  endif
  if (n == 1) then
     bessi(0) = bessi0(x)
     bessi(1) = bessi1(x)
     return
  endif

  tox = two/abs(x)
  bip = zero
  bi = one
  m = 2*((n+int(sqrt(real(iacc*n,dp)))))
  do j = m, 1, -1
     bim = bip + j*tox*bi
     bip = bi
     bi = bim
     if (abs(bi) > bigno .and. j > n) then
        bi = bi*bigni
        bip = bip*bigni
     endif
     if (j <= n) bessi(j) = bip
  enddo
  bip = bessi0(x)
  bessi = bessi*bip/bi
  bessi(0) = bip
  bessi(1) = bessi1(x)
  return
end subroutine bessel_i
!===============================================================
subroutine bessel_k(n,x,bessk)
  use constants
  implicit none
  integer, intent(in) :: n
  real(dp), intent(in) :: x
  real(dp), intent(out) :: bessk(0:n)
  integer :: j
  real(dp) :: bk, bkm, bkp, tox
  real(dp), external :: bessk0, bessk1

  tox = two/x
  bkm = bessk0(x)
  bk = bessk1(x)
  bessk(0) = bkm
  bessk(1) = bk
  do j =  1, n-1
     bkp = bkm + j*tox*bk
     bkm = bk
     bk = bkp
     bessk(j+1) = bk
  enddo
  return
end subroutine bessel_k
!===============================================================
function bessi0(x)
  use constants
  implicit none
  real(dp), intent(in) :: x
  real(dp) :: bessi0
  real(dp) :: a(0 : 64), b(0 : 69), c(0 : 44)
  real(dp) :: y,t,w
  integer :: i,k
  data (a(i), i = 0, 12) / &
     8.5246820682016865877d-11, 2.5966600546497407288d-9, &
     7.9689994568640180274d-8, 1.9906710409667748239d-6, &
     4.0312469446528002532d-5, 6.4499871606224265421d-4, &
     7.9012345761930579108d-3, 7.1111111109207045212d-2, &
     4.4444444444472490900d-1, 1.7777777777777532045d0, &
     4.0000000000000011182d0, 3.9999999999999999800d0, &
     1.0000000000000000001d0 / 
  data (a(i), i = 13, 25) / &
     1.1520919130377195927d-10, 2.2287613013610985225d-9, &
     8.1903951930694585113d-8, 1.9821560631611544984d-6, &
     4.0335461940910133184d-5, 6.4495330974432203401d-4, &
     7.9013012611467520626d-3, 7.1111038160875566622d-2, &
     4.4444450319062699316d-1, 1.7777777439146450067d0, &
     4.0000000132337935071d0, 3.9999999968569015366d0, &
     1.0000000003426703174d0 / 
  data (a(i), i = 26, 38) / &
     1.5476870780515238488d-10, 1.2685004214732975355d-9, &
     9.2776861851114223267d-8, 1.9063070109379044378d-6, &
     4.0698004389917945832d-5, 6.4370447244298070713d-4, &
     7.9044749458444976958d-3, 7.1105052411749363882d-2, &
     4.4445280640924755082d-1, 1.7777694934432109713d0, &
     4.0000055808824003386d0, 3.9999977081165740932d0, &
     1.0000004333949319118d0 / 
  data (a(i), i = 39, 51) / &
     2.0675200625006793075d-10, -6.1689554705125681442d-10, &
     1.2436765915401571654d-7, 1.5830429403520613423d-6, &
     4.2947227560776583326d-5, 6.3249861665073441312d-4, &
     7.9454472840953930811d-3, 7.0994327785661860575d-2, &
     4.4467219586283000332d-1, 1.7774588182255374745d0, &
     4.0003038986252717972d0, 3.9998233869142057195d0, &
     1.0000472932961288324d0 / 
  data (a(i), i = 52, 64) / &
     2.7475684794982708655d-10, -3.8991472076521332023d-9, &
     1.9730170483976049388d-7, 5.9651531561967674521d-7, &
     5.1992971474748995357d-5, 5.7327338675433770752d-4, &
     8.2293143836530412024d-3, 6.9990934858728039037d-2, &
     4.4726764292723985087d-1, 1.7726685170014087784d0, &
     4.0062907863712704432d0, 3.9952750700487845355d0, &
     1.0016354346654179322d0 / 
  data (b(i), i = 0, 13) / &
     6.7852367144945531383d-8, 4.6266061382821826854d-7, &
     6.9703135812354071774d-6, 7.6637663462953234134d-5, &
     7.9113515222612691636d-4, 7.3401204731103808981d-3, &
     6.0677114958668837046d-2, 4.3994941411651569622d-1, &
     2.7420017097661750609d0, 14.289661921740860534d0, &
     59.820609640320710779d0, 188.78998681199150629d0, &
     399.87313678256011180d0, 427.56411572180478514d0 / 
  data (b(i), i = 14, 27) / &
     1.8042097874891098754d-7, 1.2277164312044637357d-6, &
     1.8484393221474274861d-5, 2.0293995900091309208d-4, &
     2.0918539850246207459d-3, 1.9375315654033949297d-2, &
     1.5985869016767185908d-1, 1.1565260527420641724d0, &
     7.1896341224206072113d0, 37.354773811947484532d0, &
     155.80993164266268457d0, 489.52113711585409180d0, &
     1030.9147225169564806d0, 1093.5883545113746958d0 / 
  data (b(i), i = 28, 41) / &
     4.8017305613187493564d-7, 3.2613178439123800740d-6, &
     4.9073137508166159639d-5, 5.3806506676487583755d-4, &
     5.5387918291051866561d-3, 5.1223717488786549025d-2, &
     4.2190298621367914765d-1, 3.0463625987357355872d0, &
     18.895299447327733204d0, 97.915189029455461554d0, &
     407.13940115493494659d0, 1274.3088990480582632d0, &
     2670.9883037012547506d0, 2815.7166284662544712d0 / 
  data (b(i), i = 42, 55) / &
     1.2789926338424623394d-6, 8.6718263067604918916d-6, &
     1.3041508821299929489d-4, 1.4282247373727478920d-3, &
     1.4684070635768789378d-2, 1.3561403190404185755d-1, &
     1.1152592585977393953d0, 8.0387088559465389038d0, &
     49.761318895895479206d0, 257.26842323135291380d0, &
     1066.8543146269566231d0, 3328.3874581009636362d0, &
     6948.8586598121634874d0, 7288.4893398212481055d0 / 
  data (b(i), i = 56, 69) / &
     3.4093503681970328930d-6, 2.3079025203103376076d-5, &
     3.4691373283901830239d-4, 3.7949949772229085450d-3, &
     3.8974209677945602145d-2, 3.5949483804148783710d-1, &
     2.9522878893539528226d0, 21.246564609514287056d0, &
     131.28727387146173141d0, 677.38107093296675421d0, &
     2802.3724744545046518d0, 8718.5731420798254081d0, &
     18141.348781638832286d0, 18948.925349296308859d0 / 
  data (c(i), i = 0, 8) / &
     2.5568678676452702768d-15, 3.0393953792305924324d-14, &
     6.3343751991094840009d-13, 1.5041298011833009649d-11, &
     4.4569436918556541414d-10, 1.7463930514271679510d-8, &
     1.0059224011079852317d-6, 1.0729838945088577089d-4, &
     5.1503226936425277380d-2 / 
  data (c(i), i = 9, 17) / &
     5.2527963991711562216d-15, 7.2021184814210056410d-15, &
     7.2561421229904797156d-13, 1.4823121466731042510d-11, &
     4.4602670450376245434d-10, 1.7463600061788679671d-8, &
     1.0059226091322347560d-6, 1.0729838937545111487d-4, &
     5.1503226936437300716d-2 / 
  data (c(i), i = 18, 26) / &
     1.3365917359358069908d-14, -1.2932643065888544835d-13, &
     1.7450199447905602915d-12, 1.0419051209056979788d-11, &
     4.5804788198059832600d-10, 1.7442405450073548966d-8, &
     1.0059461453281292278d-6, 1.0729837434500161228d-4, &
     5.1503226940658446941d-2 / 
  data (c(i), i = 27, 35) / &
     5.3771611477352308649d-14, -1.1396193006413731702d-12, &
     1.2858641335221653409d-11, -5.9802086004570057703d-11, &
     7.3666894305929510222d-10, 1.6731837150730356448d-8, &
     1.0070831435812128922d-6, 1.0729733111203704813d-4, &
     5.1503227360726294675d-2 / 
  data (c(i), i = 36, 44) / &
     3.7819492084858931093d-14, -4.8600496888588034879d-13, &
     1.6898350504817224909d-12, 4.5884624327524255865d-11, &
     1.2521615963377513729d-10, 1.8959658437754727957d-8, &
     1.0020716710561353622d-6, 1.0730371198569275590d-4, &
     5.1503223833002307750d-2 / 
  w = abs(x)
  if (w .lt. 8.5d0) then
      t = w * w * 0.0625d0
      k = 13 * (int(t))
      y = (((((((((((a(k) * t + a(k + 1)) * t + &
         a(k + 2)) * t + a(k + 3)) * t + a(k + 4)) * t + &
         a(k + 5)) * t + a(k + 6)) * t + a(k + 7)) * t + &
         a(k + 8)) * t + a(k + 9)) * t + a(k + 10)) * t + &
         a(k + 11)) * t + a(k + 12)
  else if (w .lt. 12.5d0) then
      k = int(w)
      t = w - k
      k = 14 * (k - 8)
      y = ((((((((((((b(k) * t + b(k + 1)) * t + &
         b(k + 2)) * t + b(k + 3)) * t + b(k + 4)) * t + &
         b(k + 5)) * t + b(k + 6)) * t + b(k + 7)) * t + &
         b(k + 8)) * t + b(k + 9)) * t + b(k + 10)) * t + &
         b(k + 11)) * t + b(k + 12)) * t + b(k + 13)
  else
      t = 60 / w
      k = 9 * (int(t))
      y = ((((((((c(k) * t + c(k + 1)) * t + &
         c(k + 2)) * t + c(k + 3)) * t + c(k + 4)) * t + &
         c(k + 5)) * t + c(k + 6)) * t + c(k + 7)) * t + &
         c(k + 8)) * sqrt(t) * exp(w)
  end if
  bessi0 = y
  return
end function bessi0
!===============================================================
function bessi1(x)
  use constants
  implicit none
  real(dp), intent(in) :: x
  real(dp) :: bessi1
  real(dp) :: a(0 : 59), b(0 : 69), c(0 : 44)
  real(dp) :: y,t,w
  integer :: i,k
  data (a(i), i = 0, 11) / &
     1.2787464404046789181d-10, 3.5705860060088241077d-9, &
     9.9611537619347335040d-8, 2.2395070088633043177d-6, &
     4.0312466928887462346d-5, 5.6437387840203722356d-4, &
     5.9259259312934746096d-3, 4.4444444443499008870d-2, &
     2.2222222222232042719d-1, 6.6666666666666139867d-1, &
     1.0000000000000001106d0, 4.9999999999999999962d-1 / 
  data (a(i), i = 12, 23) / &
     1.7281952384448634449d-10, 3.0647204559976390130d-9, &
     1.0237662138842827028d-7, 2.2299494417341498163d-6, &
     4.0335364374929326943d-5, 5.6433440269141349899d-4, &
     5.9259754885893798654d-3, 4.4444399410880397870d-2, &
     2.2222225112835026730d-1, 6.6666665422146063244d-1, &
     1.0000000032274936821d0, 4.9999999961866867205d-1 / 
  data (a(i), i = 24, 35) / &
     2.3216048939948030996d-10, 1.7443372702334489579d-9, &
     1.1596478963485415499d-7, 2.1446755518623035147d-6, &
     4.0697440347437076195d-5, 5.6324394900433192204d-4, &
     5.9283484996093060678d-3, 4.4440673899150997921d-2, &
     2.2222638016852657860d-1, 6.6666358151576732094d-1, &
     1.0000013834029985337d0, 4.9999971643129650249d-1 / 
  data (a(i), i = 36, 47) / &
     3.1013758938255172562d-10, -8.4813676145611694984d-10, &
     1.5544980187411802596d-7, 1.7811109378708045726d-6, &
     4.2945322199060856985d-5, 5.5344850176852353639d-4, &
     5.9590327716950614802d-3, 4.4371611097707060659d-2, &
     2.2233578241986401111d-1, 6.6654747300463315310d-1, &
     1.0000756505206705927d0, 4.9997803664415994554d-1 / 
  data (a(i), i = 48, 59) / &
     4.1214758313965020365d-10, -5.3613317735347429440d-9, &
     2.4661360807517345161d-7, 6.7144593918926723203d-7, &
     5.1988027944945587571d-5, 5.0165568586065803067d-4, &
     6.1717530047005289953d-3, 4.3745229577317251404d-2, &
     2.2363147971477747996d-1, 6.6475469131117660240d-1, &
     1.0015686689447547657d0, 4.9941120439785391891d-1 / 
  data (b(i), i = 0, 13) / &
     6.6324787943143095845d-8, 4.5125928898466638619d-7, &
     6.7937793134877246623d-6, 7.4580507871505926302d-5, &
     7.6866382927334005919d-4, 7.1185174803491859307d-3, &
     5.8721838073486424416d-2, 4.2473949281714196041d-1, &
     2.6396965606282079123d0, 13.710008536637016903d0, &
     57.158647688180932003d0, 179.46182892089389037d0, &
     377.57997362398478619d0, 399.87313678256009819d0 / 
  data (b(i), i = 14, 27) / &
     1.7652713206027939711d-7, 1.1988179244834708057d-6, &
     1.8037851545747139231d-5, 1.9775785516370314656d-4, &
     2.0354870702829387283d-3, 1.8822164191032253600d-2, &
     1.5500485219010424263d-1, 1.1190100010560573210d0, &
     6.9391565185406617552d0, 35.948170579648649345d0, &
     149.41909525103032616d0, 467.42979492780642582d0, &
     979.04227423171290408d0, 1030.9147225169564443d0 / 
  data (b(i), i = 28, 41) / &
     4.7022299276154507603d-7, 3.1878571710170115972d-6, &
     4.7940153875711448496d-5, 5.2496623508411440227d-4, &
     5.3968661134780824779d-3, 4.9837081920693776234d-2, &
     4.0979593830387765545d-1, 2.9533186922862948404d0, &
     18.278176130722516369d0, 94.476497150189121070d0, &
     391.66075612645333624d0, 1221.4182034643210345d0, &
     2548.6177980961291004d0, 2670.9883037012546541d0 / 
  data (b(i), i = 42, 55) / &
     1.2535083724002034147d-6, 8.4845871420655708250d-6, &
     1.2753227372734042108d-4, 1.3950105363562648921d-3, &
     1.4325473993765291906d-2, 1.3212452778932829125d-1, &
     1.0849287786885151432d0, 7.8068089156260172673d0, &
     48.232254570679165833d0, 248.80659424902394371d0, &
     1029.0736929484210803d0, 3200.5629438795801652d0, &
     6656.7749162019607914d0, 6948.8586598121632302d0 / 
  data (b(i), i = 56, 69) / &
     3.3439394490599745013d-6, 2.2600596902211837757d-5, &
     3.3955927589987356838d-4, 3.7105306061050972474d-3, &
     3.8065263634919156421d-2, 3.5068223415665236079d-1, &
     2.8760027832105027316d0, 20.665999500843274339d0, &
     127.47939148516390205d0, 656.43636874254000885d0, &
     2709.5242837932479920d0, 8407.1174233600734871d0, &
     17437.146284159740233d0, 18141.348781638831600d0 / 
  data (c(i), i = 0, 8) / &
     -2.8849790431465382128d-15, -3.5125350943844774657d-14, &
     -7.4850867013707419750d-13, -1.8383904048277485153d-11, &
     -5.7303556446977223342d-10, -2.4449502737311496525d-8, &
     -1.6765373351766929724d-6, -3.2189516835265773471d-4, &
     5.1503226936425277377d-2 / 
  data (c(i), i = 9, 17) / &
     -5.8674306822281631119d-15, -9.4884898451194085565d-15, &
     -8.5033865136600364340d-13, -1.8142997866945285736d-11, &
     -5.7340238386338193949d-10, -2.4449138101742183665d-8, &
     -1.6765375646678855842d-6, -3.2189516826945356325d-4, &
     5.1503226936412017608d-2 / 
  data (c(i), i = 18, 26) / &
     -1.4723362506764340882d-14, 1.3945147385179042899d-13, &
     -1.9618041857586930923d-12, -1.3343606394065121821d-11, &
     -5.8649674606973244159d-10, -2.4426060539669553778d-8, &
     -1.6765631828366988006d-6, -3.2189515191449587253d-4, &
     5.1503226931820146445d-2 / 
  data (c(i), i = 27, 35) / &
     -5.8203519372580372987d-14, 1.2266326995309845825d-12, &
     -1.3921625844526453237d-11, 6.2228025878281625469d-11, &
     -8.8636681342142794023d-10, -2.3661241616744818608d-8, &
     -1.6777870960740520557d-6, -3.2189402882677074318d-4, &
     5.1503226479551959376d-2 / 
  data (c(i), i = 36, 44) / &
     -4.5801527369223291722d-14, 6.7998819697143727209d-13, &
     -4.1624857909290468421d-12, -3.2849009406112440998d-11, &
     -3.2478275690431118270d-10, -2.5739209934053714983d-8, &
     -1.6730566573215739195d-6, -3.2190010909008684076d-4, &
     5.1503229866932077150d-2 / 
  w = abs(x)
  if (w .lt. 8.5d0) then
      t = w * w * 0.0625d0
      k = 12 * (int(t))
      y = (((((((((((a(k) * t + a(k + 1)) * t + &
         a(k + 2)) * t + a(k + 3)) * t + a(k + 4)) * t + &
         a(k + 5)) * t + a(k + 6)) * t + a(k + 7)) * t + &
         a(k + 8)) * t + a(k + 9)) * t + a(k + 10)) * t + &
         a(k + 11)) * w
  else if (w .lt. 12.5d0) then
      k = int(w)
      t = w - k
      k = 14 * (k - 8)
      y = ((((((((((((b(k) * t + b(k + 1)) * t + &
         b(k + 2)) * t + b(k + 3)) * t + b(k + 4)) * t + &
         b(k + 5)) * t + b(k + 6)) * t + b(k + 7)) * t + &
         b(k + 8)) * t + b(k + 9)) * t + b(k + 10)) * t + &
         b(k + 11)) * t + b(k + 12)) * t + b(k + 13)
  else
      t = 60 / w
      k = 9 * (int(t))
      y = ((((((((c(k) * t + c(k + 1)) * t + &
         c(k + 2)) * t + c(k + 3)) * t + c(k + 4)) * t + &
         c(k + 5)) * t + c(k + 6)) * t + c(k + 7)) * t + &
         c(k + 8)) * sqrt(t) * exp(w)
  end if
  if (x .lt. 0) y = -y
  bessi1 = y
  return
end function bessi1
!===============================================================
function bessk0(x)
  use constants
  implicit none
  real(dp), intent(in) :: x
  real(dp) :: bessk0
  real(dp) :: a(0 : 15), b(0 : 111), c(0 : 134), d(0 : 39)
  real(dp) :: y,t
  integer :: i,k
  data (a(i), i = 0, 15) / &
     2.4307270476772195953d-12, 4.7091666363785304370d-10, &
     6.7816861334344265568d-8, 6.7816840204737508252d-6, &
     4.3402777777915334676d-4, 1.5624999999999872796d-2, &
     2.5000000000000000448d-1, 9.9999999999999999997d-1, &
     6.5878327432224993071d-12, 1.2083308769932888218d-9, &
     1.6271062073716412046d-7, 1.4914719278555277887d-5, &
     8.4603509071212245667d-4, 2.5248929932162333910d-2, &
     2.7898287891460312491d-1, 1.1593151565841244874d-1 / 
  data (b(i), i = 0, 13) / &
     -4.6430702971053162197d-13, 1.0377936059563728230d-11, &
     -1.0298475936392057807d-10, 5.3632747492333959219d-10, &
     -2.1674628861036068105d-10, -2.3316071545820437669d-8, &
     2.2557819578691704059d-7, -9.2325694638587080009d-7, &
     -3.3569097781613661759d-6, 8.7355061305812582974d-5, &
     -6.8021202111645760475d-4, 2.7434654781323362319d-4, &
     1.0031787169953909561d-1, 4.2102443824070833334d-1 / 
  data (b(i), i = 14, 27) / &
     4.1447451117883103686d-12, -3.4026589638576604315d-11, &
     9.3398790624638977468d-12, 1.5184181750799852630d-9, &
     -1.1364911665083029464d-8, 2.0619457602095915719d-8, &
     3.0431018037572243630d-7, -2.9749736264474555510d-6, &
     8.0143661611467038568d-6, 8.0937525149549218398d-5, &
     -1.0356346549612699886d-3, 2.8534806627578638795d-3, &
     9.7369634474060441807d-2, 3.2175066577856452683d-1 / 
  data (b(i), i = 28, 41) / &
     1.1170882570740727520d-13, -8.2865909408297066068d-11, &
     9.4656678749191182763d-10, -3.5832019841847883380d-9, &
     -9.5017955656904252761d-9, 1.5200595674883329093d-7, &
     -3.8663262571356059980d-7, -3.3350340828235103499d-6, &
     2.9359886663960844231d-5, -1.1266401822556801563d-5, &
     -1.2113572742435576205d-3, 6.3158973673701376253d-3, &
     8.8291790250128171341d-2, 2.2833982383240512262d-1 / 
  data (b(i), i = 42, 55) / &
     -3.2880638807053948433d-11, 4.3194884830465283512d-10, &
     -1.7455089683104033093d-9, -3.2437330799994764516d-9, &
     4.7393655539139519778d-8, -1.1929265603456272466d-8, &
     -1.3177845881013419388d-6, 3.3873375636197969526d-6, &
     3.2729835880668256625d-5, -1.8367283883002494561d-4, &
     -8.2830996454188084408d-4, 9.5512732229514251931d-3, &
     7.2233832113719266702d-2, 1.4753187103603405298d-1 / 
  data (b(i), i = 56, 69) / &
     7.9998492614150860098d-11, -7.0257346702686139490d-10, &
     7.8898821627084586270d-10, 1.1294796399671507085d-8, &
     -1.1360539648638059137d-8, -3.0346309115270564487d-7, &
     3.2235585426189451721d-7, 8.3575612102298214948d-6, &
     -8.5169628089198208211d-6, -2.5740175232173357342d-4, &
     1.2462734014689152770d-4, 1.0683232869192203450d-2, &
     5.1515690033637395779d-2, 8.5465862953544883657d-2 / 
  data (b(i), i = 70, 83) / &
     -8.6111506537356531608d-11, 5.1862926131024597823d-10, &
     7.5884324949371110022d-10, -6.4011975813006767417d-9, &
     -4.1966181325111763156d-8, 9.1306285446881485314d-8, &
     1.3573638315827954034d-6, 4.8683213252735694701d-7, &
     -3.8805424608710197066d-5, -1.1838986468688980610d-4, &
     9.2796213947750964945d-4, 8.9611057737319027776d-3, &
     3.1464453915862785606d-2, 4.4267648087536630780d-2 / 
  data (b(i), i = 84, 97) / &
     4.4400123834164610288d-11, -1.1411233140911074336d-10, &
     -8.8200670702467059830d-10, -1.9686735373323381456d-9, &
     1.9921120728941773855d-8, 1.4543974418584834740d-7, &
     1.8238418041265854754d-8, -4.5363700392899066037d-6, &
     -2.1688068222527688542d-5, 4.5496062166687034700d-5, &
     1.0435238076080528284d-3, 5.8374528996419979931d-3, &
     1.6611210710425455850d-2, 2.0756008367065750538d-2 / 
  data (b(i), i = 98, 111) / &
     -6.5166519951106397214d-12, -5.8572182858788539580d-11, &
     1.5550375065815375404d-10, 1.9526509484993563229d-9, &
     9.2637123346818426594d-9, -1.4136471501812055943d-8, &
     -4.3024895710889717172d-7, -2.3235612243330592076d-6, &
     4.0380616133862188804d-7, 9.2783767992909743602d-5, &
     7.2964887597817095035d-4, 3.1316245282223273413d-3, &
     7.8028233022066428316d-3, 9.0014807263791058095d-3 / 
  data (c(i), i = 0, 14) / &
     4.5161032649342790231d-11, -4.2774336988557091369d-11, &
     6.0998467173896677777d-10, 1.9845167242599996944d-9, &
     1.3097678767280215271d-8, 7.4505822268382641286d-8, &
     4.2893920879106814989d-7, 2.3900851955655303104d-6, &
     1.2533473009382380357d-5, 5.9693359063879871983d-5, &
     2.4775070661087304580d-4, 8.5106703131389516508d-4, &
     2.2500105115665788755d-3, 4.0446134454521634600d-3, &
     3.6910983340425942762d-3 / 
  data (c(i), i = 15, 29) / &
     3.5732826433251464989d-12, -3.2906649482312266258d-12, &
     7.0873811190464760555d-11, 2.9551320580484177120d-10, &
     2.2776940472505079894d-9, 1.5175463612815010036d-8, &
     9.9462487812170164133d-8, 6.1448757797853901100d-7, &
     3.4869531882907360750d-6, 1.7615836644757657443d-5, &
     7.6373536037879531886d-5, 2.7098571871205999668d-4, &
     7.3399047381788927036d-4, 1.3439197177355085297d-3, &
     1.2439943280131230863d-3 / 
  data (c(i), i = 30, 44) / &
     3.6343547836242523646d-13, 9.7997961751276137602d-14, &
     1.0184692699811569047d-11, 6.1495184828957652064d-11, &
     5.0238328349302602543d-10, 3.7498626376004337661d-9, &
     2.6689445483857236307d-8, 1.7591899737346368084d-7, &
     1.0486448307010701679d-6, 5.4986458466257148573d-6, &
     2.4521456351751345323d-5, 8.8900942259143832228d-5, &
     2.4483947714068300190d-4, 4.5418248688489693045d-4, &
     4.2479574186923180694d-4 / 
  data (c(i), i = 45, 59) / &
     5.2460389348163395857d-14, 7.4802063026503503540d-14, &
     2.0012201610651998417d-12, 1.4887306044735163359d-11, &
     1.2946705414232940350d-10, 1.0391628915892803144d-9, &
     7.8091180499677328456d-9, 5.3694223626907660084d-8, &
     3.3063914804658509029d-7, 1.7776972424421486506d-6, &
     8.0833148098458320202d-6, 2.9755556304448817780d-5, &
     8.2945928349220642178d-5, 1.5536921180500112883d-4, &
     1.4647070522281538711d-4 / 
  data (c(i), i = 60, 74) / &
     9.7531436733955514559d-15, 2.4084291220447154982d-14, &
     4.7654956400897494468d-13, 4.0200949504810597783d-12, &
     3.6726577109162191533d-11, 3.0939005665422637601d-10, &
     2.4122848979784500179d-9, 1.7071884462645525505d-8, &
     1.0752238955654933405d-7, 5.8844190041189462347d-7, &
     2.7136083303224014597d-6, 1.0102477728604441135d-5, &
     2.8420490721532571809d-5, 5.3637016379451944413d-5, &
     5.0881312956459247572d-5 / 
  data (c(i), i = 75, 89) / &
     2.1732049868189377260d-15, 7.2720052142815590531d-15, &
     1.2803083795536820100d-13, 1.1696825543787717167d-12, &
     1.1083298191597132094d-11, 9.6536661252658773139d-11, &
     7.7242553835198536397d-10, 5.5798366267110575620d-9, &
     3.5721345296543414370d-8, 1.9806931547193682466d-7, &
     9.2312964655319555313d-7, 3.4666258590861079959d-6, &
     9.8224698307751177077d-6, 1.8648773453825584428d-5, &
     1.7780062316167651812d-5 / 
  data (c(i), i = 90, 104) / &
     5.5012463763851934112d-16, 2.2254763392767319419d-15, &
     3.7187669817701214965d-14, 3.5819585377733489628d-13, &
     3.4866061263191556694d-12, 3.1101633450629652910d-11, &
     2.5358235662235617663d-10, 1.8597629779492599046d-9, &
     1.2052654739462999992d-8, 6.7501417351172136833d-8, &
     3.1720052198654584574d-7, 1.1993651363602981832d-6, &
     3.4179130317623363474d-6, 6.5208606745808860158d-6, &
     6.2430205476536771454d-6 / 
  data (c(i), i = 105, 119) / &
     1.5225407517829491689d-16, 6.9834820025664405161d-16, &
     1.1380182837138781431d-14, 1.1369488761077196511d-13, &
     1.1291168681618466716d-12, 1.0250757630526871007d-11, &
     8.4765287317253141514d-11, 6.2886627779402596211d-10, &
     4.1142865598366029316d-9, 2.3223773435632014408d-8, &
     1.0985095234166396934d-7, 4.1766260951820336228d-7, &
     1.1958609263543792991d-6, 2.2907574647671878055d-6, &
     2.2008253973114914005d-6 / 
  data (c(i), i = 120, 134) / &
     4.4863058691420695911d-17, 2.2437356594371819978d-16, &
     3.6107964803015652759d-15, 3.7031193629853392081d-14, &
     3.7341552790439784371d-13, 3.4355950129497564468d-12, &
     2.8719942600171304499d-11, 2.1499646844509516453d-10, &
     1.4171810843455227171d-9, 8.0501118772875784153d-9, &
     3.8281889106330295876d-8, 1.4621673458431979989d-7, &
     4.2029868696411098586d-7, 8.0785884122023473025d-7, &
     7.7845438614204963209d-7 / 
  data (d(i), i = 0, 7) / &
     -7.9737703860537066166d-14, 1.9543834380466766627d-12, &
     -4.7230794431646733538d-11, 1.4001773785771252004d-9, &
     -5.4864553020583098585d-8, 3.1601984250143742772d-6, &
     -3.3708783204090252161d-4, 1.6180215937964160437d-1 / 
  data (d(i), i = 8, 15) / &
     -5.2593898374798632343d-14, 1.7725913926973236457d-12, &
     -4.6672234858122387294d-11, 1.3991653503828889207d-9, &
     -5.4863400156413929639d-8, 3.1601976099900075541d-6, &
     -3.3708783171335864627d-4, 1.6180215937958433760d-1 / 
  data (d(i), i = 16, 23) / &
     -3.6135496189875398132d-14, 1.5466239429618130284d-12, &
     -4.5320259146602122624d-11, 1.3945974109459385552d-9, &
     -5.4853994841172088787d-8, 3.1601858228022739196d-6, &
     -3.3708782339998302320d-4, 1.6180215937704286491d-1 / 
  data (d(i), i = 24, 31) / &
     -2.5640663123518180635d-14, 1.3288079339404032671d-12, &
     -4.3368537955908371563d-11, 1.3848103653102203186d-9, &
     -5.4824335664256344123d-8, 3.1601315173126153586d-6, &
     -3.3708776779035695640d-4, 1.6180215935248373474d-1 / 
  data (d(i), i = 32, 39) / &
     -1.8678321325292127767d-14, 1.1354310934105733311d-12, &
     -4.1057197297998608931d-11, 1.3693990961296350970d-9, &
     -5.4762428935047089835d-8, 3.1599817092775027963d-6, &
     -3.3708756559715893599d-4, 1.6180215923508144240d-1 / 
  if (x .lt. 0.86d0) then
      t = x * x
      y = ((((((a(0) * t + a(1)) * t + &
         a(2)) * t + a(3)) * t + a(4)) * t + &
         a(5)) * t + a(6)) * t + a(7) 
      y = ((((((a(8) * t + a(9)) * t + &
         a(10)) * t + a(11)) * t + a(12)) * t + &
         a(13)) * t + a(14)) * t + a(15) - y * log(x) 
  else if (x .lt. 4.15d0) then
      t = x - 5 / x
      k = int(t + 5)
      t = (k - 4) - t
      k = k * 14
      y = ((((((((((((b(k) * t + b(k + 1)) * t + &
         b(k + 2)) * t + b(k + 3)) * t + b(k + 4)) * t + &
         b(k + 5)) * t + b(k + 6)) * t + b(k + 7)) * t + &
         b(k + 8)) * t + b(k + 9)) * t + b(k + 10)) * t + &
         b(k + 11)) * t + b(k + 12)) * t + b(k + 13)
  else if (x .lt. 12.5d0) then
      k = int(x)
      t = (k + 1) - x
      k = 15 * (k - 4)
      y = (((((((((((((c(k) * t + c(k + 1)) * t + &
         c(k + 2)) * t + c(k + 3)) * t + c(k + 4)) * t + &
         c(k + 5)) * t + c(k + 6)) * t + c(k + 7)) * t + &
         c(k + 8)) * t + c(k + 9)) * t + c(k + 10)) * t + &
         c(k + 11)) * t + c(k + 12)) * t + c(k + 13)) * t + &
         c(k + 14)
  else
      t = 60 / x
      k = 8 * (int(t))
      y = (((((((d(k) * t + d(k + 1)) * t + &
         d(k + 2)) * t + d(k + 3)) * t + d(k + 4)) * t + &
         d(k + 5)) * t + d(k + 6)) * t + d(k + 7)) * &
         sqrt(t) * exp(-x)
  end if
  bessk0 = y
end function bessk0
!===============================================================
function bessk1(x)
  use constants
  implicit none
  real(dp), intent(in) :: x
  real(dp) :: bessk1
  real(dp) :: a(0 : 15), b(0 : 119), c(0 : 119), d(0 : 39)
  real(dp) :: y,t,v
  integer :: i,k
  data (a(i), i = 0, 15) / &
     1.5151605362537935201d-13, 3.3637909513536510350d-11, &
     5.6514041131016827202d-9, 6.7816840255069534052d-7, &
     5.4253472222259226487d-5, 2.6041666666666637057d-3, &
     6.2500000000000000090d-2, 5.0000000000000000000d-1, &
     -8.9790303384748696588d-11, -1.4029047449249185771d-8,& 
     -1.5592893752540998113d-6, -1.1253607018469017569d-4, &
     -4.6421827665011579173d-3, -8.5370719728648409609d-2, &
     -3.0796575782920629660d-1, 1.0000000000000000004d0 / 
  data (b(i), i = 0, 14) / &
     -9.4055461896630579928d-12, 3.1307934665844664773d-11, &
     4.2005295001519243251d-10, -4.1636196779679820012d-9, &
     1.4483026181700966164d-8, 1.1661000205428816914d-8, &
     -3.5023996724943046209d-7, 1.4404279316339005012d-6, &
     5.3581564157158242080d-7, -3.5249754038612334639d-5, &
     1.7150324075631641453d-4, -4.1276362611239191024d-5, &
     -4.6943110979636602591d-3, 3.5085369853392357659d-2, &
     2.0063574339907819159d-1 / 
  data (b(i), i = 15, 29) / &
     3.3998989888944034586d-11, 7.1558979072937373055d-11, &
     -2.9226856932927698732d-9, 1.4591620256525610213d-8, &
     -6.6141635609854161666d-9, -1.9991101838984472332d-7, &
     5.9185836628873530572d-7, 1.9562880347358085687d-6, &
     -1.5814366450418102764d-5, 7.6791682910944612028d-6, &
     2.8354678948323983936d-4, -1.0217932669418690641d-3, &
     -3.2205661865210048433d-3, 4.3497494842354644077d-2, &
     1.6110284302315089935d-1 / 
  data (b(i), i = 30, 44) / &
     -2.0933987679665541827d-10, 7.9503322090520447316d-10, &
     3.8000150948242575774d-9, -2.3076136195585571309d-8, &
     -2.3902880302550799653d-8, 3.1914500937804377478d-7, &
     3.2639909831082417694d-7, -5.3166994792995439449d-6, &
     -3.1109524694269240094d-6, 9.2575906966353273247d-5, &
     7.5063709094147644746d-7, -1.7416491592625765379d-3, &
     1.2138560335171676007d-3, 4.5879687144659643175d-2, &
     1.1566544716132846709d-1 / 
  data (b(i), i = 45, 59) / &
     3.1582384905164908749d-10, -1.9959561818098999516d-9, &
     8.6959328920030927557d-10, 1.1642778282445577109d-8, &
     4.3552264337818440471d-8, -1.5057982160481803238d-7, &
     -1.0101729117980989857d-6, 7.7002002510177612013d-7, &
     1.9580574235590194233d-5, 1.9358461980242834361d-5, &
     -3.3932339942485532728d-4, -9.3416673584325090073d-4, &
     5.5800080455912847227d-3, 3.8668683062477179235d-2, &
     7.2651643500517000658d-2 / 
  data (b(i), i = 60, 74) / &
     -1.1554749629758510059d-10, 8.2270678758893273006d-10, &
     -5.0211156951551538591d-10, -1.4929179050554858361d-9, &
     -2.7107940791526366702d-8, -4.2204764086705349384d-8, &
     3.7253098167927628867d-7, 2.4374697215363361156d-6, &
     1.4141942006909768370d-6, -4.8766389019473918231d-5, &
     -2.1681387247526720978d-4, 2.9325729929653405236d-4, &
     6.4087534504827239815d-3, 2.6054628289709454356d-2, &
     4.0156431128194184336d-2 / 
  data (b(i), i = 75, 89) / &
     2.5506555170746221691d-11, -1.3521164018407978152d-10, &
     -8.3281235274106699399d-11, -9.7764849575562351891d-10, &
     3.4661828409940354542d-9, 3.9760633711791357544d-8, &
     1.5902906645504529930d-7, -1.4919441249454941275d-7, &
     -5.3779684992094351263d-6, -2.7513862296246223142d-5, &
     -9.7880089725297162007d-6, 7.0787668964515789714d-4, &
     4.6968199862345387583d-3, 1.4745740181663320127d-2, &
     2.0048622219583455723d-2 / 
  data (b(i), i = 90, 104) / &
     -3.4824483072529265585d-12, 1.5157161810563380451d-12, &
     8.5303859696700686144d-12, 3.3455414203743741076d-10, &
     2.0226016353844285376d-9, 5.3128154003266334990d-9, &
     -3.0799322316418042137d-8, -4.4455408272954712128d-7, &
     -2.4293274626893384034d-6, -3.2129079340119038354d-6, &
     5.9225403683075388850d-5, 5.6822962576781683532d-4, &
     2.7152446516406682732d-3, 7.4075873691848838485d-3, &
     9.3044450815739269849d-3 / 
  data (b(i), i = 105, 119) / &
     -2.7683216166276377232d-13, 3.1986676777610155465d-12, &
     9.4142986954031445666d-12, 6.7934609179456399334d-11, &
     3.4851529411470029330d-11, -2.5785248508896551557d-9, &
     -2.8310220027112571258d-8, -1.6384131113072271115d-7, &
     -3.2521663350596379097d-7, 4.0381388757622307160d-6, &
     5.1917606978077281001d-5, 3.3420027947470126154d-4, &
     1.3699550623118247094d-3, 3.4405619148342271096d-3, &
     4.1042919106665762794d-3 / 
  data (c(i), i = 0, 14) / &
     4.5281968025889407937d-12, 1.0806749918195271176d-11, &
     9.6200972728717669027d-11, 5.7214227063625263650d-10, &
     3.6077804282954825099d-9, 2.2465236858536681852d-8, &
     1.3676961264308735230d-7, 7.9561767489531997361d-7, &
     4.3014380065615550573d-6, 2.0921713905550285590d-5, &
     8.8079183950590176926d-5, 3.0549414408830252064d-4, &
     8.1295715613927890473d-4, 1.4679809476357079195d-3, &
     1.3439197177355090057d-3 / 
  data (c(i), i = 15, 29) / &
     7.6019964430402432637d-13, -2.2616198599158271190d-13, &
     1.7904450823779000744d-11, 9.1467054855312232717d-11, &
     7.1378582044879519122d-10, 4.9925255415445769102d-9, &
     3.3767315471315546644d-8, 2.1350774539167751457d-7, &
     1.2314353082655232903d-6, 6.2918685053670619181d-6, &
     2.7493229298777000013d-5, 9.8085825401369821771d-5, &
     2.6670282677770444935d-4, 4.8967895428135985381d-4, &
     4.5418248688489697144d-4 / 
  data (c(i), i = 30, 44) / &
     9.4180115230375147213d-14, 7.5943117003734061145d-14, &
     3.0335730243874287654d-12, 2.0202796115462268051d-11, &
     1.6839020189186971198d-10, 1.2907875663127201526d-9, &
     9.3547676125865798920d-9, 6.2471974110281880722d-8, &
     3.7585985422997380441d-7, 1.9838348288114906484d-6, &
     8.8884862203671982034d-6, 3.2333259238682810218d-5, &
     8.9266668913380400243d-5, 1.6589185669844051903d-4, &
     1.5536921180500113394d-4 / 
  data (c(i), i = 45, 59) / &
     1.5425475332301107271d-14, 2.8674534590132490434d-14, &
     6.5078462279160216936d-13, 5.0939757793961391211d-12, &
     4.4979837460748975520d-11, 3.6662925847520171711d-10, &
     2.7848878755089582413d-9, 1.9298120059339477820d-8, &
     1.1950323861976892013d-7, 6.4513432758147478287d-7, &
     2.9422095033982461936d-6, 1.0854433321174584937d-5, &
     3.0307433185818899481d-5, 5.6840981443065017850d-5, &
     5.3637016379451945253d-5 / 
  data (c(i), i = 60, 74) / &
     3.1077953698439839352d-15, 8.6899496170729520378d-15, &
     1.6258562067326054104d-13, 1.4104842571366761537d-12, &
     1.3019455544084110747d-11, 1.1070466372863950239d-10, &
     8.6890603844230597917d-10, 6.1793722175049967488d-9, &
     3.9058865943755615801d-8, 2.1432806981070368523d-7, &
     9.9034657762983230155d-7, 3.6925185861895664251d-6, &
     1.0399877577259449786d-5, 1.9644939661550210015d-5, &
     1.8648773453825584597d-5 / 
  data (c(i), i = 75, 89) / &
     7.2831555285336286457d-16, 2.6077534095895783532d-15, &
     4.4881202059263153495d-14, 4.1674329383944385626d-13, &
     3.9760100480223728037d-12, 3.4835976355351183010d-11, &
     2.7993254212770249700d-10, 2.0286513276830758107d-9, &
     1.3018343087118439152d-8, 7.2315927974997999365d-8, &
     3.3750708681924201599d-7, 1.2688020879407355571d-6, &
     3.5980954090811587848d-6, 6.8358260635246667316d-6, &
     6.5208606745808860557d-6 / 
  data (c(i), i = 90, 104) / &
     1.9026412343503745875d-16, 8.0073765508732553766d-16, &
     1.3245754278055523992d-14, 1.2885201653055058502d-13, &
     1.2600129301230402587d-12, 1.1283306843147549277d-11, &
     9.2261481309646814329d-11, 6.7812033168299846818d-10, &
     4.4020645304595102132d-9, 2.4685719238301517679d-8, &
     1.1611886719473112509d-7, 4.3940380936523135466d-7, &
     1.2529878285546791905d-6, 2.3917218527087570384d-6, &
     2.2907574647671878160d-6 / 
  data (c(i), i = 105, 119) / &
     5.3709522135744366512d-17, 2.5239221050372845433d-16, &
     4.0933147145899083360d-15, 4.1152784247617592367d-14, &
     4.0998840572769381012d-13, 3.7319354625807158852d-12, &
     3.0921671702920868014d-11, 2.2975898538634445343d-10, &
     1.5049754445782364328d-9, 8.5030864719789148982d-9, &
     4.0250559391118423810d-8, 1.5312755642491878591d-7, &
     4.3865020375297892208d-7, 8.4059737392822153101d-7, &
     8.0785884122023473319d-7 / 
  data (d(i), i = 0, 7) / &
     9.2371554649979581914d-14, -2.3111336195788410887d-12, &
     5.7728710326649832559d-11, -1.8002298130091372598d-9, &
     7.6810375010517145638d-8, -5.2669973752193823306d-6, &
     1.0112634961227401357d-3, 1.6180215937964160466d-1 / 
  data (d(i), i = 8, 15) / &
     6.1381146507252683381d-14, -2.1034499679806301862d-12, &
     5.7090233460448415278d-11, -1.7990724350642330817d-9, &
     7.6809056078388019946d-8, -5.2669964425290062357d-6, &
     1.0112634957478283390d-3, 1.6180215937970716383d-1 / 
  data (d(i), i = 16, 23) / &
     4.2458150578401296419d-14, -1.8435733128339016981d-12, &
     5.5534955081564656595d-11, -1.7938162188526358466d-9, &
     7.6798230945934117807d-8, -5.2669828728791921259d-6, &
     1.0112634861753356559d-3, 1.6180215938263409582d-1 / 
  data (d(i), i = 24, 31) / &
     3.0314798962267007518d-14, -1.5915009905364214455d-12, &
     5.3275907427402047438d-11, -1.7824862013841369751d-9, &
     7.6763890356447075810d-8, -5.2669199860465945909d-6, &
     1.0112634217687349189d-3, 1.6180215941108227283d-1 / 
  data (d(i), i = 32, 39) / &
     2.2211515002229271212d-14, -1.3664088221521734796d-12, &
     5.0585177270502341602d-11, -1.7645432205894533462d-9, &
     7.6691805594577373698d-8, -5.2667455286976269634d-6, &
     1.0112631862810974580d-3, 1.6180215954783127877d-1 / 
  if (x .lt. 0.8d0) then
      t = x * x
      y = (((((((a(0) * t + a(1)) * t + &
         a(2)) * t + a(3)) * t + a(4)) * t + &
         a(5)) * t + a(6)) * t + a(7)) * x
      y = (((((((a(8) * t + a(9)) * t + &
         a(10)) * t + a(11)) * t + a(12)) * t + &
         a(13)) * t + a(14)) * t + a(15)) / x + &
         y * log(x)
  else if (x .lt. 5.5d0) then
      v = 3 / x
      t = x - v
      k = int(t + 3)
      t = (k - 2) - t
      k = k * 15
      y = ((((((((((((((b(k) * t + b(k + 1)) * t + &
         b(k + 2)) * t + b(k + 3)) * t + b(k + 4)) * t + &
         b(k + 5)) * t + b(k + 6)) * t + b(k + 7)) * t + &
         b(k + 8)) * t + b(k + 9)) * t + b(k + 10)) * t + &
         b(k + 11)) * t + b(k + 12)) * t + b(k + 13)) * t + &
         b(k + 14)) * v
  else if (x .lt. 12.5d0) then
      k = int(x)
      t = (k + 1) - x
      k = 15 * (k - 5)
      y = (((((((((((((c(k) * t + c(k + 1)) * t + &
         c(k + 2)) * t + c(k + 3)) * t + c(k + 4)) * t + &
         c(k + 5)) * t + c(k + 6)) * t + c(k + 7)) * t + &
         c(k + 8)) * t + c(k + 9)) * t + c(k + 10)) * t + &
         c(k + 11)) * t + c(k + 12)) * t + c(k + 13)) * t + &
         c(k + 14)
  else
      t = 60 / x
      k = 8 * (int(t))
      y = (((((((d(k) * t + d(k + 1)) * t + &
         d(k + 2)) * t + d(k + 3)) * t + d(k + 4)) * t + &
         d(k + 5)) * t + d(k + 6)) * t + d(k + 7)) * &
         sqrt(t) * exp(-x)
  end if
  bessk1 = y
  return
end function bessk1
!===============================================================
